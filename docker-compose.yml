version: '3.8'

services:
  mongodb:
    image: mongo:7.0
    container_name: lastmile-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=lastmile
    volumes:
      - mongodb_data:/data/db
    networks:
      - lastmile-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: lastmile-redis
    ports:
      - "6379:6379"
    networks:
      - lastmile-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  station-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.station
    image: lastmile/station-service:latest
    container_name: lastmile-station-service
    ports:
      - "50051:50051"
    environment:
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - lastmile-network
    restart: unless-stopped

  user-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.user
    image: lastmile/user-service:latest
    container_name: lastmile-user-service
    ports:
      - "50052:50052"
    environment:
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - lastmile-network
    restart: unless-stopped

  driver-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.driver
    image: lastmile/driver-service:latest
    container_name: lastmile-driver-service
    ports:
      - "50053:50053"
    environment:
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - STATION_SERVICE_HOST=station-service
      - STATION_SERVICE_PORT=50051
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mongodb:
        condition: service_healthy
      station-service:
        condition: service_started
    networks:
      - lastmile-network
    restart: unless-stopped

  rider-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.rider
    image: lastmile/rider-service:latest
    container_name: lastmile-rider-service
    ports:
      - "50054:50054"
    environment:
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - lastmile-network
    restart: unless-stopped

  location-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.location
    image: lastmile/location-service:latest
    container_name: lastmile-location-service
    ports:
      - "50055:50055"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - lastmile-network
    restart: unless-stopped

  matching-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.matching
    image: lastmile/matching-service:latest
    container_name: lastmile-matching-service
    ports:
      - "50056:50056"
    environment:
      - DRIVER_SERVICE_HOST=driver-service
      - DRIVER_SERVICE_PORT=50053
      - TRIP_SERVICE_HOST=trip-service
      - TRIP_SERVICE_PORT=50057
      - STATION_SERVICE_HOST=station-service
      - STATION_SERVICE_PORT=50051
      - RIDER_SERVICE_HOST=rider-service
      - RIDER_SERVICE_PORT=50054
      - NOTIFICATION_SERVICE_HOST=notification-service
      - NOTIFICATION_SERVICE_PORT=50058
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      driver-service:
        condition: service_started
      trip-service:
        condition: service_started
    networks:
      - lastmile-network
    restart: unless-stopped

  trip-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.trip
    image: lastmile/trip-service:latest
    container_name: lastmile-trip-service
    ports:
      - "50057:50057"
    environment:
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - RIDER_SERVICE_HOST=rider-service
      - RIDER_SERVICE_PORT=50054
      - DRIVER_SERVICE_HOST=driver-service
      - DRIVER_SERVICE_PORT=50053
      - NOTIFICATION_SERVICE_HOST=notification-service
      - NOTIFICATION_SERVICE_PORT=50058
      - USER_SERVICE_HOST=user-service
      - USER_SERVICE_PORT=50052
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - lastmile-network
    restart: unless-stopped

  notification-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.notification
    image: lastmile/notification-service:latest
    container_name: lastmile-notification-service
    ports:
      - "50058:50058"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - user-service
    networks:
      - lastmile-network
    restart: unless-stopped

  gateway:
    image: envoyproxy/envoy:v1.31-latest
    container_name: lastmile-gateway
    ports:
      - "8080:8080"     # API Gateway HTTP endpoint
      - "9901:9901"     # Envoy admin
    volumes:
      - ./envoy/envoy.yaml:/etc/envoy/envoy.yaml
      - ./proto.pb:/etc/envoy/proto.pb
    depends_on:
      - station-service
      - user-service
      - driver-service
      - rider-service
      - location-service
      - matching-service
      - trip-service
      - notification-service
    networks:
      - lastmile-network
    restart: unless-stopped

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    image: lastmile/new-frontend:latest
    container_name: lastmile-frontend
    ports:
      - "3000:80"
    environment:
      - VITE_API_BASE_URL=http://lastmile-gateway:8080
    depends_on:
      - gateway
    networks:
      - lastmile-network
    restart: unless-stopped

  gen-proto:
    image: node:18-bullseye
    volumes:
      - .:/app
    working_dir: /app
    command: >
      bash -c "set -e &&
      apt-get update && apt-get install -y protobuf-compiler &&
      mkdir -p frontend/src/proto &&
      rm -rf frontend/src/proto/* &&
      npm install -g protoc-gen-ts protoc-gen-grpc-web &&
      PROTOC_GEN_TS_PATH=$$(which protoc-gen-ts) &&
      PROTOC_GEN_GRPC_WEB_PATH=$$(which protoc-gen-grpc-web) &&
      echo \"Using TS plugin: $$PROTOC_GEN_TS_PATH\" &&
      echo \"Using GRPC plugin: $$PROTOC_GEN_GRPC_WEB_PATH\" &&
      mkdir -p frontend/src/proto/google/api &&
      protoc -I=googleapis googleapis/google/api/annotations.proto googleapis/google/api/http.proto --plugin=protoc-gen-ts=\"$$PROTOC_GEN_TS_PATH\" --plugin=protoc-gen-grpc-web=\"$$PROTOC_GEN_GRPC_WEB_PATH\" --js_out=import_style=commonjs,binary:frontend/src/proto --ts_out=frontend/src/proto --grpc-web_out=import_style=typescript,mode=grpcwebtext:frontend/src/proto &&
      protoc -I=backend/proto -I=googleapis --include_imports --include_source_info --descriptor_set_out=proto.pb backend/proto/*.proto &&
      for proto_file in backend/proto/*.proto; do
        echo \"Compiling $$proto_file...\" &&
        protoc -I=backend/proto -I=googleapis \"$$proto_file\" --plugin=protoc-gen-ts=\"$$PROTOC_GEN_TS_PATH\" --plugin=protoc-gen-grpc-web=\"$$PROTOC_GEN_GRPC_WEB_PATH\" --js_out=import_style=commonjs,binary:frontend/src/proto --ts_out=frontend/src/proto --grpc-web_out=import_style=commonjs,mode=grpcwebtext:frontend/src/proto;
      done"
    networks:
      - lastmile-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.2.0
    container_name: lastmile-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - lastmile-network

  logstash:
    image: docker.elastic.co/logstash/logstash:9.2.0
    container_name: lastmile-logstash
    volumes:
      - ./elk/logstash/pipeline:/usr/share/logstash/pipeline
    ports:
      - "5044:5044"
      - "5000:5000/tcp"
      - "5000:5000/udp"
      - "9600:9600"
    environment:
      LS_JAVA_OPTS: "-Xmx1g -Xms1g"
    depends_on:
      - elasticsearch
    networks:
      - lastmile-network

  kibana:
    image: docker.elastic.co/kibana/kibana:9.2.0
    container_name: lastmile-kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    networks:
      - lastmile-network

  filebeat:
    image: docker.elastic.co/beats/filebeat:9.2.0
    container_name: lastmile-filebeat
    user: root
    volumes:
      - ./elk/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - logstash
    networks:
      - lastmile-network

volumes:
  mongodb_data:
    driver: local
  elasticsearch_data:
    driver: local

networks:
  lastmile-network:
    driver: bridge
