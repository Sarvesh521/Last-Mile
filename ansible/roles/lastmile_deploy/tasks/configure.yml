---
# ------------------------------------------------------------------
# 3. Cluster Configuration (Secrets, Ingress, Certs)
# ------------------------------------------------------------------
- name: Render Secrets Manifest from Vault
  template:
    src: secrets.yaml.j2
    dest: "{{ ansible_env.HOME }}/k8s-deployment/00-secrets.yaml"

- name: Copy existing Microservice Manifests
  copy:
    src: ../../../../k8s-springboot/
    dest: "{{ ansible_env.HOME }}/k8s-deployment/"

- name: Enable Ingress Addon (Minikube)
  command: minikube addons enable ingress
  ignore_errors: yes

- name: Wait for Ingress Controller to be Ready
  command: kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=300s
  ignore_errors: yes

- name: Enable Metrics Server (Required for HPA)
  command: minikube addons enable metrics-server
  ignore_errors: yes

- name: Generate Self-Signed Certificate for HTTPS
  command: openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout "{{ ansible_env.HOME }}/lastmile.key" -out "{{ ansible_env.HOME }}/lastmile.crt" -subj "/CN=lastmile.local"
  args:
    creates: "{{ ansible_env.HOME }}/lastmile.crt"

- name: Create TLS Secret
  shell: |
    kubectl create secret tls lastmile-tls \
      --key "{{ ansible_env.HOME }}/lastmile.key" \
      --cert "{{ ansible_env.HOME }}/lastmile.crt" \
      --dry-run=client -o yaml | kubectl apply -f -
